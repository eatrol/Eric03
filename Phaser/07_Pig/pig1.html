<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>myfishing game</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<div id='showxy'></div>

<script type="text/javascript">

var factor = window.innerWidth/1200; 
factor =1;



var config = {
    type: Phaser.CANVAS,
    width: 1100*factor,
    height: 700*factor,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};


var mycard,youcard,hiscard;
var myhome,youhome;
var cards = [];
var my;
var myturn;
var mybutton=[];
var myT = [1,2,3,4,5];
var youT = [6,7,8,9,10];
var allT = [1,2,3,4,5,6,7,8,9,10];
var library;

var current;
var timetext;
var librarytext;
var statustext;
var timer;

var frametime = 0;
var textsize = 30;


function initial(){
    shuffle();  // 重新洗牌
    frametime = 0;
    myturn = true;
    
}


var game = new Phaser.Game(config);

function preload (){

    // this.load.image('bg5', 'static/bear/bg5.png');
    // this.load.spritesheet('cook8', 'static/bear/cook8.png', { frameWidth: 123.3, frameHeight: 66 });
    // this.load.spritesheet('cook9', 'static/bear/cook9.png', { frameWidth: 123.3, frameHeight: 66 });  
    // this.load.audio('coin','static/fish/coin.mp3');
    // this.load.audio('animaltheme','static/fish/animaltheme.mp3');
    this.load.image('bg10','static/pig/bg10.png')
    this.load.image('card0', 'static/pig/card0.png');
    this.load.image('card1', 'static/pig/card1.png');
    this.load.image('card2', 'static/pig/card2.png');
    this.load.image('card3', 'static/pig/card3.png');
    this.load.image('card4', 'static/pig/card4.png');
    this.load.image('card5', 'static/pig/card5.png');
    this.load.image('card6', 'static/pig/card6.png');
    this.load.image('card7', 'static/pig/card7.png');
    this.load.image('card8', 'static/pig/card8.png');
    this.load.image('card9', 'static/pig/card9.png');
    this.load.image('card10', 'static/pig/card10.png');
    this.load.image('card11', 'static/pig/card11.png');
    this.load.image('card12', 'static/pig/card12.png');
    this.load.image('card13', 'static/pig/card13.png');
    this.load.image('card14', 'static/pig/card14.png');
    this.load.image('card15', 'static/pig/card15.png');


    this.load.image('select1', 'static/pig/select1.png');
    this.load.image('select2', 'static/pig/select2.png');
    this.load.image('select3', 'static/pig/select3.png');
    this.load.image('select4', 'static/pig/select4.png');
    this.load.image('select5', 'static/pig/select5.png');
    this.load.image('select6', 'static/pig/select6.png');
    this.load.image('select7', 'static/pig/select7.png');
    this.load.image('select8', 'static/pig/select8.png');
    this.load.image('select9', 'static/pig/select9.png');
    this.load.image('select10', 'static/pig/select10.png');
    this.load.image('select11', 'static/pig/select11.png');
    this.load.image('select12', 'static/pig/select12.png');
    this.load.image('select13', 'static/pig/select13.png');
    this.load.image('select14', 'static/pig/select14.png');
    this.load.image('select15', 'static/pig/select15.png');

    this.load.image('menu1', 'static/pig/menu1.png');
    this.load.image('menu2', 'static/pig/menu2.png');

}

function create (){

    initial(); // 載入初始設定參數


    
    
    
    // music = this.sound.add('coin',{volume:0.2}) ;
    // music2 = this.sound.add('animaltheme',{loop:true, volume:3});
    // music2.loop = true;
    // music2.stop();
    // music2.play();
    

    //  加入背景圖面
    //this.add.image(game.config.width/2, game.config.height/2, 'bg5').setScale(factor);

   
    this.add.image(1100/2, 700/2, "bg10");
    //this.add.image(400,300,"card01");

    // //  Input Events
   // 設定所有卡片
    cards[0] = new newcard(0,"card0",0, 0,"card0",0,0,0,0,11,11);
    cards[1] = new newcard(1,"card1",8 ,9 ,"select1" ,10,11,12,13,myT ,youT);
    cards[2] = new newcard(2,"card2",8 ,10,"select2" ,9 ,11,0 ,0 ,myT ,youT);
    cards[3] = new newcard(3,"card3",10,12,"select3" ,11,13,0 ,0 ,myT ,youT);
    cards[4] = new newcard(4,"card4",11,14,"select4" ,13,15,0 ,0 ,myT ,youT);
    cards[5] = new newcard(5,"card5",10,8 ,"select5" ,11,9 ,14,9 ,youT,myT);
    cards[6] = new newcard(6,"card6",9 ,8 ,"select6" ,11,10,13,12,youT,myT);
    cards[7] = new newcard(7,"card7",9 ,8 ,"select7" ,0 ,0 ,0 ,0 ,allT,allT);
    cards[8] = new newcard(8,"card8",0 ,0 ,"select8" );
    cards[9] = new newcard(9,"card9",0 ,0 ,"select9" );
    cards[10] = new newcard(10,"card10",0 ,0 ,"select10" );
    cards[11] = new newcard(11,"card11",0 ,0 ,"select11" );
    cards[12] = new newcard(12,"card12",0 ,0 ,"select12" );
    cards[13] = new newcard(13,"card13",0 ,0 ,"select13" );
    cards[14] = new newcard(14,"card14",0 ,0 ,"select14" );
    cards[15] = new newcard(15,"card15",0 ,0 ,"select15" );




    // Menu
    menu1   = this.physics.add.sprite(250, 355, 'menu1').setScale(factor*0.5);
    menu2   = this.physics.add.sprite(250, 300, 'menu2').setScale(factor*0.5);
    //初始化所有盤子
    favor1 = this.physics.add.group();
    // // 設定按鍵屬性
    var gg = library[0]
    mybutton[0] = new newbutton(favor1.create(151*factor, 355*factor, 'card'+gg),cards[gg],0);
  

    mybutton[1] = new newbutton(favor1.create(565*factor, 479*factor, 'card8'),cards[8],1);
    mybutton[2] = new newbutton(favor1.create(747*factor, 479*factor, 'card8'),cards[8],2);
    mybutton[3] = new newbutton(favor1.create(929*factor, 479*factor, 'card9'),cards[9],3);
    mybutton[4] = new newbutton(favor1.create(656*factor, 603*factor, 'card9'),cards[9],4);
    mybutton[5] = new newbutton(favor1.create(838*factor, 603*factor, 'card9'),cards[9],5);

    mybutton[6] = new newbutton(favor1.create(656*factor, 132*factor, 'card9'),cards[9],6);
    mybutton[7] = new newbutton(favor1.create(838*factor, 132*factor, 'card9'),cards[9],7);
    mybutton[8] = new newbutton(favor1.create(565*factor, 262*factor, 'card8'),cards[8],8);
    mybutton[9] = new newbutton(favor1.create(747*factor, 262*factor, 'card8'),cards[8],9);
    mybutton[10] = new newbutton(favor1.create(929*factor, 262*factor, 'card9'),cards[9],10);
   

    mybutton[11] = new newbutton(favor1.create(104*factor, 552*factor, 'card3'),cards[3],11);
    mybutton[12] = new newbutton(favor1.create(232*factor, 552*factor, 'card3'),cards[3],12);
    mybutton[13] = new newbutton(favor1.create(360*factor, 552*factor, 'card3'),cards[3],13);

    mybutton[14] = new newbutton(favor1.create(104*factor, 154*factor, 'card3'),cards[3],14);
    mybutton[15] = new newbutton(favor1.create(232*factor, 154*factor, 'card3'),cards[3],15);
    mybutton[16] = new newbutton(favor1.create(360*factor, 154*factor, 'card3'),cards[3],16);

    mybutton[17] = new newbutton(favor1.create(2000*factor, 2000*factor, 'card0'),cards[0],17);

    my = new newmy(mybutton);
    current = mybutton[17];
    console.log(my);


    favor1.children.iterate(function (child) {
        child.setScale(factor);
    });

    mybutton[0].favor.setScale(0.8*factor); // 牌酷的牌比較小


    sendcard(); // 重新發牌

    //============================
    // 設定點擊後的反應=
    mybutton[0].favor.setInteractive().on('pointerdown', () => {
        drawcard(11,13);
    
    })

    mybutton[11].favor.setInteractive().on('pointerdown', () => {
        if(myturn){
            my.setMyTurn();
            current = mybutton[11]
            current.setSelect();
            goCheck();
        }
    })

    mybutton[12].favor.setInteractive().on('pointerdown', () => {
        if(myturn){
            my.setMyTurn();
            current = mybutton[12]
            current.setSelect();
            goCheck();
        }
    })

    mybutton[13].favor.setInteractive().on('pointerdown', () => {
        if(myturn){
            my.setMyTurn();
            current = mybutton[13]
            current.setSelect();
            goCheck();
        }
    })

    mybutton[16].favor.setInteractive().on('pointerdown', () => {
        my.setMyTurn();

    })

    
    mybutton[1].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[1]);
    })

    mybutton[2].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[2]);
    })

    mybutton[3].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[3]);
    })

    mybutton[4].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[4]);
    })

    mybutton[5].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[5]);
    })


    mybutton[6].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[6]);
    })

    mybutton[7].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[7]);
    })

    mybutton[8].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[8]);

    })

    mybutton[9].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[9]);

    })

    mybutton[10].favor.setInteractive().on('pointerdown', () => {
        goChange(mybutton[10]);

    })


    menu1.setInteractive().on('pointerdown', () => {
        checkDrop();
    })

    menu2.setInteractive().on('pointerdown', () => {
    
        console.log(current.id);
        if(current.id >=11 && current.id <=13){
            current.setCard(0);
        }
        
    })

 
    //================================



    
    //==================================


    // // 秀出分數跟時間
    // scoreText = this.add.text(scoreX, scoreY, '0', { fontSize: textsize, fill: '#000' });
    // wormText = this.add.text(wormX, wormY, worm, { fontSize: textsize, fill: '#000' });

    timetext = this.add.text(game.config.width-300*factor,25*factor,'time:'+frametime,{ fontSize: textsize, fill: '#000' });
    librarytext = this.add.text(220*factor,400*factor,library.length,{ fontSize: textsize*0.7, fill: '#000' });
    statustext = this.add.text(50*factor, 20*factor, "My turn", { fontSize: textsize*0.7, fill: '#000' });    



    cursors = this.input.keyboard.createCursorKeys();
   
}


//********************************************
// 更新：主程式
//************************************
function update (){


    if (!myturn){
        statustext.setText("Computer's turn");
        AIaction();        

    }else{
        statustext.setText("My Turn");


    }

    var pointer = this.input.activePointer;
        if (pointer.isDown ) {
            
        }

    // // 遊戲結束
    // if (gameOver){
    //     timetext.setText('Game Over');
    //     return;
    // }

    // // 判斷餐點(mybutton)的狀態, 是否烤熟 or 烤焦
    // for (var i=0 ; i< mybutton.length; i++){
    //     if (mybutton[i].cooktime< 0 && mybutton[i].favor.ani != ""){
    //         mybutton[i].setBecome();
    //     } else {      
    //         mybutton[i].cooktime -=1;
    //     }
    // }

    // // 判斷是否顧客(user)可以關閉 , 如果兩個order都沒了就可以關閉客戶
    // for (var i=0; i< user.length;i++){
    //     var user1 = user[i];
    //     if( user1.order.active== false && user1.order2.active == false){
    //         user1.customer.disableBody(true,true);
    //     }
    // }

    // // 自動產生客戶
    // if(frametime % 250 == 0 ){
    //     for (var i=0; i< user.length;i++){
    //         var user1 = user[i];
    //         if( user1.customer.active == false  ){
    //             adduser(user1);
    //             break;
    //         }
    //     }
    // }


    timetext.setText('time:'+frametime);
    librarytext.setText(library.length);
    frametime += 1;
}



function shuffle(){  
        var cardqty  =   [0,21,9 ,4 ,4 ,4 ,8 ,4 ];
        var k = 0;
        var arr = [];
        for (var i=1; i<=7; i++){
            var cardnum = cardqty[i];
            for(var j=0; j< cardnum; j++){
                arr[k] = i;
                k++;
            }
        }    
        var newArr=[];
        randomSort(arr,newArr);
        library = newArr;

}



function randomSort(arr, newArr) {
    // 如果原陣列arr的length值等於1時，原陣列只有一個值，其鍵值為0
    // 同時將這個值push到新陣列newArr中
    if(arr.length == 1) {
        newArr.push(arr[0]);
        return newArr; // 相當於遞迴退出
    }
    // 在原陣列length基礎上取出一個隨機數
    var random = Math.ceil(Math.random() * arr.length) - 1;
    // 將原陣列中的隨機一個值push到新陣列newArr中
    newArr.push(arr[random]);
    // 對應刪除原陣列arr的對應陣列項
    arr.splice(random,1);
    return randomSort(arr, newArr);
}


function newcard(type,name,mate1,to1,select,mate2,to2,mate3,to3,mytarget,youtarget){
    this.type = type;
    this.name = name;
    this.isClick = false;
    this.mate1 = mate1;
    this.to1 = to1;
    this.selectname = select;
    this.mate2 = mate2;
    this.to2 = to2;
    this.mate3 = mate3;
    this.to3 = to3;
    this.mytarget = mytarget;
    this.youtarget = youtarget;
}



function newbutton(favor,carding,id){
    this.favor = favor;
    this.card = carding;
    this.id = id;
    this.isClick = false;
    this.isSelect = false;
    this.setSelect= function(){
        this.isClick = true;
        this.isSelect = true;
        this.favor.setTexture(this.card.selectname);
    }

    this.setCard = function(n){
        this.card = cards[n];
        this.favor.setTexture(this.card.name);
    }
}


function newmy(button){
    this.button = button;
    this.setClick = function(){
        for(var i=0; i< this.button.length ; i++){
            this.button[i].isClick = true;
        }
       
    }

    this.setNoClick = function(){
        for(var i=0; i< this.button.length ; i++){
            this.button[i].isClick = false;
        }
    }

    this.setMyTurn = function(){  // 只有三個牌可以按
        for(var i=0; i< this.button.length ; i++){
            this.button[i].isClick = false;
            this.button[i].isSelect = false;
            this.button[i].favor.setTexture(this.button[i].card.name);
        }
        for(var i=10; i<= 13 ; i++){
            this.button[i].isClick = true;
        }
        current = mybutton[17];   
    }    
}

// 重新發牌
function sendcard(){
    for(var i=11; i<=16; i++){
        gg = library[0]
        mybutton[i].card = cards[gg];
        mybutton[i].favor.setTexture('card'+gg);
        library.splice(0,1);
    }
    
}

function delay(n){
    game.scene.scenes[0].physics.pause();   
    var n1 = n*300000000;
    for(var i=0; i<=n1; i++){
    }
    game.scene.scenes[0].physics.resume();
}


function goCheck(){
    //my.setNoClick();
    var mycheck=[];
    var mate1 = current.card.mate1;
    var mate2 = current.card.mate2;
    var mate3 = current.card.mate3;
    var clist = myturn ? current.card.mytarget : current.card.youtarget;
    for(var i=0; i<clist.length ; i++){
        
        youbut = mybutton[clist[i]];
        if (mate1 == youbut.card.type){
            youbut.setSelect();
            mycheck.push(clist[i]);
        }else if(mate2 == youbut.card.type){
            youbut.setSelect();
            mycheck.push(clist[i]);
        }else if(mate3 == youbut.card.type){
            youbut.setSelect();
            mycheck.push(clist[i]);
        }
    }
    console.log(mycheck.length);
    return mycheck;

}

function goChange(youbut){
    if(youbut.isClick){

    
    if(current.card.type ==7){
        var israin = false;
        for(var i=1;i<=10;i++){
            youbut = mybutton[i];
            if (youbut.card.type ==9 ){
                youbut.card = cards[8];
                israin = true;
            }
        }
        if(israin){
            current.setCard(0)
            my.setNoClick();
        }

    }else{
        var mate1 = current.card.mate1;
        var mate2 = current.card.mate2;
        var mate3 = current.card.mate3;
        var clist = current.card.mytarget;

        if (mate1 == youbut.card.type){
            youbut.setCard(current.card.to1);
            current.setCard(0);
            my.setNoClick();
        }else if(mate2 == youbut.card.type){
            youbut.setCard(current.card.to2);
            current.setCard(0);
            my.setNoClick();
        }else if(mate3 == youbut.card.type){
            youbut.setCard(current.card.to3);
            current.setCard(0);
            my.setNoClick();
        }
    }
    my.setMyTurn();

    
    }

}
    


function drawcard(n1,n2){
    my.setMyTurn();
    for (var i=n1;i<=n2;i++){
        current = mybutton[i];
        if (current.card.type ==0 ){
            var gg = library[0];
            current.card = cards[gg];
            current.favor.setTexture(current.card.name);
            library.splice(0,1);
            myturn = false;
        }
    }   
    mybutton[0].setCard(library[0]);
    my.setMyTurn;


}


function checkDrop(){
    current = mybutton[11];
    var c1 = goCheck().length;
    current = mybutton[12];
    c1 = c1 + goCheck().length;
    current = mybutton[13];
    c1 = c1 + goCheck().length;
    if(c1 == 0){
        mybutton[11].card = cards[0];
        mybutton[12].card = cards[0];
        mybutton[13].card = cards[0];
        //alert('hi');
    }
    my.setMyTurn();
    return c1;
}

function AIaction(){
    for(var i=14; i<=16; i++){
        my.setMyTurn();
        current = mybutton[i]
        current.setSelect();
        goCheck();
        
        // if (goCheck().length !=0){
        //     var gg = goCheck().length ;
        //     var youbut = mybutton[gg[0]];
        //     goChange(youbut);
        //     myturn = true;
        //     break;
        // }
    }
    myturn = true;

}




function callback(){


}









</script>

</body>
</html>