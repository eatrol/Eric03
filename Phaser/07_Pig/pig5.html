<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Dirty Pig </title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<div id='showxy'></div>

<script type="text/javascript">

var factorL = window.innerWidth/1100; 
//factor =1;
var factor = window.innerHeight/700;


var config = {
    type: Phaser.CANVAS,
    width: 1100*factorL,
    height: 700*factor,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};


var mycard,youcard,hiscard;
var myhome,youhome;
var cards = [];
var my;
var myturn;
var mybutton=[];
var myT = [1,2,3,4,5];
var youT = [6,7,8,9,10];
var allT = [1,2,3,4,5,6,7,8,9,10];
var library;
var gameover;
var current,target,isGoChange,isGoChangeTime;
var timetext;
var librarytext;
var statustext;
var timer;
var dalaytime;

var frametime = 0;
var textsize = 30;


function initial(){
    shuffle();  // 重新洗牌
    frametime = 0;
    myturn = true;
    gameover = false;
    delaytime =0;
    isGoChange = false;
    
}


var game = new Phaser.Game(config);

function preload (){

    // this.load.image('bg5', 'static/bear/bg5.png');
    // this.load.spritesheet('cook8', 'static/bear/cook8.png', { frameWidth: 123.3, frameHeight: 66 });
    // this.load.spritesheet('cook9', 'static/bear/cook9.png', { frameWidth: 123.3, frameHeight: 66 });  
    // this.load.audio('coin','static/fish/coin.mp3');
    this.load.audio('animaltheme','static/pig/animaltheme.mp3');
    //this.load.audio('coin','static/pig/coin.mp3');
    this.load.audio('cardopen','static/pig/cardopen.ogg');

    //this.load.image('bg10','static/pig/bg10.png')
    this.load.image('bg10','static/pig/bg13.jpg');
    this.load.image('bg11','static/pig/bg11.png');


    this.load.image('card0', 'static/pig/card0.png');
    this.load.image('card1', 'static/pig/card1.png');
    this.load.image('card2', 'static/pig/card2.png');
    this.load.image('card3', 'static/pig/card3.png');
    this.load.image('card4', 'static/pig/card4.png');
    this.load.image('card5', 'static/pig/card5.png');
    this.load.image('card6', 'static/pig/card6.png');
    this.load.image('card7', 'static/pig/card7.png');
    // this.load.image('card8', 'static/pig/card8.png');
    // this.load.image('card9', 'static/pig/card9.png');
    this.load.image('card8', 'static/pig/pig08.png');
    this.load.image('card9', 'static/pig/pig09.png');
    this.load.image('card10', 'static/pig/pig10.png');
    this.load.image('card11', 'static/pig/pig11.png');
    this.load.image('card12', 'static/pig/pig12.png');
    this.load.image('card13', 'static/pig/pig13.png');
    this.load.image('card14', 'static/pig/pig14.png'); 

    this.load.image('card14', 'static/pig/card14.png');
    this.load.image('card15', 'static/pig/card15.png');


    this.load.image('select1', 'static/pig/select1.png');
    this.load.image('select2', 'static/pig/select2.png');
    this.load.image('select3', 'static/pig/select3.png');
    this.load.image('select4', 'static/pig/select4.png');
    this.load.image('select5', 'static/pig/select5.png');
    this.load.image('select6', 'static/pig/select6.png');
    this.load.image('select7', 'static/pig/select7.png');
    // this.load.image('select8', 'static/pig/select8.png');
    // this.load.image('select9', 'static/pig/select9.png');
    // this.load.image('select10', 'static/pig/select10.png');
    // this.load.image('select11', 'static/pig/select11.png');
    // this.load.image('select12', 'static/pig/select12.png');
    // this.load.image('select13', 'static/pig/select13.png');
        //this.load.image('select14', 'static/pig/select14.png');
    this.load.image('select8', 'static/pig/pig08s.png');
    this.load.image('select9', 'static/pig/pig09s.png');
    this.load.image('select10', 'static/pig/pig10s.png');
    this.load.image('select11', 'static/pig/pig11s.png');
    this.load.image('select12', 'static/pig/pig12s.png');
    this.load.image('select13', 'static/pig/pig13s.png');
    this.load.image('select14', 'static/pig/pig14s.png');


    this.load.image('select15', 'static/pig/select15.png');

    this.load.image('menu1', 'static/pig/menu1.png');
    this.load.image('menu2', 'static/pig/menu2.png');

    //this.load.spritesheet('ani01', 'static/pig/ani01.png', { frameWidth: 1100, frameHeight: 700 });
    this.load.spritesheet('ani01', 'static/pig/tr01.png', { frameWidth: 1100, frameHeight: 700 });
    //this.load.spritesheet('cat', 'static/pig/cat.png', { frameWidth: 100, frameHeight: 79 });
    this.load.spritesheet('cat', 'static/pig/ani02.png', { frameWidth: 150, frameHeight: 100 });
}

function create (){

    initial(); // 載入初始設定參數


    music = this.sound.add('cardopen',{volume:0.2}) ;
    music2 = this.sound.add('animaltheme',{loop:true, volume:3});
    music2.loop = true;
    music2.stop();
    music2.play();
    //

    //  加入背景圖面   
    this.add.image(game.config.width/2, game.config.height/2 , "bg10").setScale(factorL,factor);


    //player= this.add.image(game.config.width/2, game.config.height/2 , "bg11").setScale(factor);

    this.anims.create({
        key: 'ani01',
        frames: this.anims.generateFrameNumbers('ani01', { start: 0, end: 29 }),
        frameRate: 8,
        repeat: 0
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('cat', { start: 0, end: 10 }),
        frameRate: 7,
        repeat: 0
    });


  
   // 設定所有卡片
    cards[0] = new newcard(0  ,0 ,"card0",0, 0,"card0",0,0,0,0,11,11);
    cards[1] = new newcard(1  ,0 ,"card1",8 ,9 ,"select1" ,10,11,12,13,myT ,youT);
    cards[2] = new newcard(2  ,0 ,"card2",8 ,10,"select2" ,9 ,11,0 ,0 ,myT ,youT);
    cards[3] = new newcard(3  ,0 ,"card3",10,12,"select3" ,11,13,0 ,0 ,myT ,youT);
    cards[4] = new newcard(4  ,0 ,"card4",11,14,"select4" ,13,15,0 ,0 ,myT ,youT);
    cards[5] = new newcard(5  ,0 ,"card5",10,8 ,"select5" ,11,9 ,14,9 ,youT,myT);
    cards[6] = new newcard(6  ,0 ,"card6",9 ,8 ,"select6" ,11,10,13,12,youT,myT);
    cards[7] = new newcard(7  ,0 ,"card7",9 ,8 ,"select7" ,0 ,0 ,0 ,0 ,allT,allT);
    cards[8] = new newcard(8  ,0 ,"card8",0 ,0 ,"select8" );
    cards[9] = new newcard(9  ,1 ,"card9",0 ,0 ,"select9" );
    cards[10] = new newcard(10,0,"card10",0 ,0 ,"select10" );
    cards[11] = new newcard(11,1,"card11",0 ,0 ,"select11" );
    cards[12] = new newcard(12,0,"card12",0 ,0 ,"select12" );
    cards[13] = new newcard(13,1,"card13",0 ,0 ,"select13" );
    cards[14] = new newcard(14,1,"card14",0 ,0 ,"select14" );
    cards[15] = new newcard(15,1,"card15",0 ,0 ,"select15" );


    // 設定按鍵功能
    menu1   = this.physics.add.sprite(250*factor, 355*factor, 'menu1').setScale(factor*0.5);
    menu2   = this.physics.add.sprite(250*factor, 300*factor, 'menu2').setScale(factor*0.5);
    
    //初始化所有盤子
    favor1 = this.physics.add.group();
    // // 設定按鍵屬性
    var gg = library[0]
    mybutton[0] = new newbutton(favor1.create(151*factor, 355*factor, 'card'+gg),cards[gg],0);
    
    // 我的農場
    mybutton[1] = new newbutton(favor1.create(565*factor, 479*factor, 'card8'),cards[8],1);
    mybutton[2] = new newbutton(favor1.create(747*factor, 479*factor, 'card8'),cards[8],2);
    mybutton[3] = new newbutton(favor1.create(929*factor, 479*factor, 'card8'),cards[8],3);
    mybutton[4] = new newbutton(favor1.create(656*factor, 603*factor, 'card8'),cards[8],4);
    mybutton[5] = new newbutton(favor1.create(838*factor, 603*factor, 'card8'),cards[8],5);
    // 電腦的農場
    mybutton[6] = new newbutton(favor1.create(656*factor, 132*factor, 'card8'),cards[8],6);
    mybutton[7] = new newbutton(favor1.create(838*factor, 132*factor, 'card8'),cards[8],7);
    mybutton[8] = new newbutton(favor1.create(565*factor, 262*factor, 'card8'),cards[8],8);
    mybutton[9] = new newbutton(favor1.create(747*factor, 262*factor, 'card8'),cards[8],9);
    mybutton[10] = new newbutton(favor1.create(929*factor, 262*factor, 'card8'),cards[8],10);
    // 我的手牌
    mybutton[11] = new newbutton(favor1.create(104*factor, 552*factor, 'card3'),cards[3],11);
    mybutton[12] = new newbutton(favor1.create(232*factor, 552*factor, 'card3'),cards[3],12);
    mybutton[13] = new newbutton(favor1.create(360*factor, 552*factor, 'card3'),cards[3],13);
    // 電腦的手牌
    mybutton[14] = new newbutton(favor1.create(104*factor, 154*factor, 'card3'),cards[3],14);
    mybutton[15] = new newbutton(favor1.create(232*factor, 154*factor, 'card3'),cards[3],15);
    mybutton[16] = new newbutton(favor1.create(360*factor, 154*factor, 'card3'),cards[3],16);

    // 額外
    mybutton[17] = new newbutton(favor1.create(2000*factor, 2000*factor, 'card0'),cards[0],17);

    my = new newmy(mybutton);
    
    current = mybutton[17];
    
    favor1.children.iterate(function (child) {
        child.setScale(factor);
    });

    mybutton[0].favor.setScale(0.8*factor); // 牌酷的牌比較小

    sendcard(); // 重新發牌
    my.setMyTurn();


    //============================
    // 設定點擊後的反應=
    mybutton[0].favor.setInteractive().on('pointerdown', () => {
        drawcard();
    
    })

    mybutton[11].favor.setInteractive().on('pointerdown', () => {
        if(myturn && mybutton[11].isClick){
            my.setMyTurn();
            current = mybutton[11]
            current.setSelect();
            goCheck();
        }
    })

    mybutton[12].favor.setInteractive().on('pointerdown', () => {
        if(myturn && mybutton[11].isClick){
            my.setMyTurn();
            current = mybutton[12]
            current.setSelect();
            goCheck();
        }
    })

    mybutton[13].favor.setInteractive().on('pointerdown', () => {
        if(myturn && mybutton[11].isClick){
            my.setMyTurn();
            current = mybutton[13]
            current.setSelect();
            goCheck();
        }
    })

    mybutton[16].favor.setInteractive().on('pointerdown', () => {
        my.setMyTurn();

    })

    
    mybutton[1].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[1]); })

    mybutton[2].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[2]); })

    mybutton[3].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[3]); })

    mybutton[4].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[4]); })

    mybutton[5].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[5]); })

    mybutton[6].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[6]); })

    mybutton[7].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[7]); })

    mybutton[8].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[8]); })

    mybutton[9].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[9]); })

    mybutton[10].favor.setInteractive().on('pointerdown', () => { goChange(mybutton[10]); })



    menu1.setInteractive().on('pointerdown', () => { checkDrop(); })

    menu2.setInteractive().on('pointerdown', () => {
        console.log(current.id);
        if(current.id >=11 && current.id <=13){
            current.setCard(0);
        }
    })



    //================================


    // // 秀出分數跟時間
    timetext = this.add.text(game.config.width-300*factor,25*factor,'time:'+frametime,{ fontSize: textsize, fill: '#000' });
    librarytext = this.add.text(220*factor,400*factor,library.length,{ fontSize: textsize*0.7, fill: '#000' });
    statustext = this.add.text(50*factor, 20*factor, "My turn", { fontSize: textsize*0.7, fill: '#000' });    


    // 轉場動畫
    player = this.physics.add.sprite(game.config.width/2,game.config.height/2, 'bg11');
    player.setScale(factorL,factor);

    cursors = this.input.keyboard.createCursorKeys();

   
}


//********************************************
// 更新：主程式
//************************************
function update (){

    gameCheck();
    // 遊戲結束
    if(gameover){
       
        statustext.setText("Game Over");
        return ;
    }

    if(myturn){
        delaytime = frametime + 120 ;
    }



    // 判斷是誰的回合
    if (!myturn && frametime > delaytime){
        statustext.setText("Computer's turn");
        player.anims.stop();
        player.setTexture('bg11');
        //setTimeout(AIaction(),1000000)
        AIaction();   
        
    }else if(!myturn && frametime > delaytime-80){
        player.anims.play('ani01',true);  

    }else if(!myturn){
        statustext.setText("Computer's turn");
        
        
    }else{
        statustext.setText("My Turn");
    }


    if (isGoChange && frametime < isGoChangeTime ){
        target.favor.anims.play('right',true);

    }else if(isGoChange && frametime > isGoChangeTime ){
        isGoChange = false;
        target.favor.anims.stop();
        target.favor.setTexture(target.card.name);
    }


    // 更新時間
    timetext.setText('time:'+frametime);
    librarytext.setText(library.length);
    frametime += 1;

}



function shuffle(){  
        var cardqty  =   [0,21,9 ,4 ,4 ,4 ,8 ,4 ];
        var k = 0;
        var arr = [];
        for (var i=1; i<=7; i++){
            var cardnum = cardqty[i];
            for(var j=0; j< cardnum; j++){
                arr[k] = i;
                k++;
            }
        }    
        var newArr=[];
        randomSort(arr,newArr);
        library = newArr;

}



function randomSort(arr, newArr) {
    // 如果原陣列arr的length值等於1時，原陣列只有一個值，其鍵值為0
    // 同時將這個值push到新陣列newArr中
    if(arr.length == 1) {
        newArr.push(arr[0]);
        return newArr; // 相當於遞迴退出
    }
    // 在原陣列length基礎上取出一個隨機數
    var random = Math.ceil(Math.random() * arr.length) - 1;
    // 將原陣列中的隨機一個值push到新陣列newArr中
    newArr.push(arr[random]);
    // 對應刪除原陣列arr的對應陣列項
    arr.splice(random,1);
    return randomSort(arr, newArr);
}


function newcard(type,count,name,mate1,to1,select,mate2,to2,mate3,to3,mytarget,youtarget){
    this.type = type;
    this.count = count;
    this.name = name;
    this.isClick = false;
    this.mate1 = mate1;
    this.to1 = to1;
    this.selectname = select;
    this.mate2 = mate2;
    this.to2 = to2;
    this.mate3 = mate3;
    this.to3 = to3;
    this.mytarget = mytarget;
    this.youtarget = youtarget;
}



function newbutton(favor,carding,id){
    this.favor = favor;
    this.card = carding;
    this.id = id;
    this.isClick = false;
    this.isSelect = false;
    this.setSelect= function(){
        this.isClick = true;
        //this.isSelect = true;
        this.favor.setTexture(this.card.selectname);
    }

    this.setCard = function(n){
        this.card = cards[n];
        this.favor.setTexture(this.card.name);
    }
}


function newmy(button){
    this.button = button;
    this.setClick = function(){
        for(var i=0; i< this.button.length ; i++){
            this.button[i].isClick = true;
        }
       
    }

    this.setNoClick = function(){
        for(var i=0; i< this.button.length ; i++){
            this.button[i].isClick = false;
            this.button[i].favor.setTexture(this.button[i].card.name);
        }
        mybutton[0].favor.setTexture('card0');
        mybutton[14].favor.setTexture('card0');
        mybutton[15].favor.setTexture('card0');
        mybutton[16].favor.setTexture('card0');

        this.button[0].setSelect()
        music.play();
    }

    this.setMyTurn = function(){  // 只有三個牌可以按
        for(var i=0; i< this.button.length ; i++){
            this.button[i].isClick = false;
            this.button[i].favor.setTexture(this.button[i].card.name);
        }
        mybutton[0].favor.setTexture('card0');
        mybutton[14].favor.setTexture('card0');
        mybutton[15].favor.setTexture('card0');
        mybutton[16].favor.setTexture('card0');

        for(var i=10; i<= 13 ; i++){
            this.button[i].isClick = true;
        }

        current = mybutton[17];   
    }    
}

// 重新發牌
function sendcard(){
    for(var i=11; i<=16; i++){
        gg = library[0]
        mybutton[i].card = cards[gg];
        mybutton[i].favor.setTexture('card'+gg);
        library.splice(0,1);
    }
    
}

function delay(n){
    game.scene.scenes[0].physics.pause();   
    var n1 = n*300000000;
    for(var i=0; i<=n1; i++){
    }
    game.scene.scenes[0].physics.resume();
}


function goCheck(){
    var mycheck=[];
    var mate1 = current.card.mate1;
    var mate2 = current.card.mate2;
    var mate3 = current.card.mate3;
    var clist = myturn ? current.card.mytarget : current.card.youtarget;
    for(var i=0; i<clist.length ; i++){
        
        youbut = mybutton[clist[i]];
        if (mate1 == youbut.card.type){
            youbut.setSelect();
            mycheck.push(clist[i]);
        }else if(mate2 == youbut.card.type){
            youbut.setSelect();
            mycheck.push(clist[i]);
        }else if(mate3 == youbut.card.type){
            youbut.setSelect();
            mycheck.push(clist[i]);
        }
    }
    //console.log(mycheck.length);
    return mycheck;

}

function goChange(youbut){
    if(youbut.isClick){
        if(current.card.type ==7){
            var israin = false;
            for(var i=1;i<=10;i++){
                youbut = mybutton[i];
                if (youbut.card.type ==9 ){
                    youbut.card = cards[8];
                    israin = true;
                }
            }
            if(israin){
                current.setCard(0)
                my.setNoClick();
            }

        }else{
            
            var mate1 = current.card.mate1;
            var mate2 = current.card.mate2;
            var mate3 = current.card.mate3;
            var clist = current.card.mytarget;

            if (mate1 == youbut.card.type){
                youbut.setCard(current.card.to1);
                target = youbut;
                isGoChange = true;
                isGoChangeTime = frametime + 30;
                current.setCard(0);
                my.setNoClick();
                
                return;
            }else if(mate2 == youbut.card.type){
                youbut.setCard(current.card.to2);
                target = youbut;
                isGoChange = true;
                isGoChangeTime = frametime + 30;
                current.setCard(0);
                my.setNoClick();
             
                return;
            }else if(mate3 == youbut.card.type){
                youbut.setCard(current.card.to3);
                target = youbut;
                isGoChange = true;
                isGoChangeTime = frametime + 30;
                current.setCard(0);
                my.setNoClick();

                return;
            }
        }
        current = mybutton[17];
        
    }

}

function gochange2(youbut,gg){
    youbut.setCard(gg);
    current.setCard(0);
    my.setNoClick();
    current = mybutton[17];

}
    


function drawcard(){
    my.setMyTurn();
    for (var i=11;i<=16;i++){
        current = mybutton[i];
        if (current.card.type ==0 ){
            var gg = library[0];
            current.card = cards[gg];
            current.favor.setTexture(current.card.name);
            library.splice(0,1);
            music.play();
            
            myturn = i<13.5 ? false: true;
        }
    }   
    mybutton[0].setCard(library[0]);
    my.setMyTurn();
    if(library.length<=2){
        shuffle();
    }

}


function checkDrop(){
    current = mybutton[11];
    var c1 = goCheck().length;
    current = mybutton[12];
    c1 = c1 + goCheck().length;
    current = mybutton[13];
    c1 = c1 + goCheck().length;
    if(c1 == 0){
        mybutton[11].card = cards[0];
        mybutton[12].card = cards[0];
        mybutton[13].card = cards[0];
        //alert('hi');
    }
    my.setMyTurn();
    return c1;
}

function AIaction(){
    //console.log(delaytime);
    for(var i=14; i<=16; i++){
        //my.setMyTurn();
        AIaction2(i);
        console.log('checking')
        if(myturn){
            break;
        }
    }

    if(frametime > delaytime + (20+(i-13)*10) ){
        mybutton[14].card = cards[0];
        drawcard();
        myturn = true;
    }


}

function AIaction2(i){
    //setTimeout(readimg(i,getname(i)),1000000); 
    
    current = mybutton[i];
    current.setSelect();
    goCheck();
    if (frametime > delaytime + (20+(i-13)*10) ){
        
    if (goCheck().length !=0){
        var gg = goCheck();
        var youbut = mybutton[gg[0]];
        goChange(youbut);
        drawcard();
        myturn = true;
        my.setMyTurn();
        //    break;
    }
    }
}






function gameCheck(){
    var counting1 = 0;
    var counting2 = 0;
    for(var i=1;i<=5;i++){
        counting1 += mybutton[i].card.count;
    }
    for(var i=6;i<=10;i++){
        counting2 += mybutton[i].card.count;
    }

    if(counting1 ==5 || counting2 ==5 ){
        gameover= true;

    }
}









</script>

</body>
</html>